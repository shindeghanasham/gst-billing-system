<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<div th:replace="fragments/header :: head('Create Invoice')"></div>
</head>
<body>
	<div th:replace="fragments/navbar :: navbar"></div>

	<div class="container mt-4 mb-3">
		<div class="row">
			<div class="col-12">
				<h2>Create New Invoice</h2>

				<form th:action="@{/invoices/create}" th:object="${invoiceRequest}"
					method="post">
					<div class="card mb-4">
						<div class="card-header">
							<h5 class="card-title mb-0">Customer Information</h5>
						</div>
						<div class="card-body">
							<div class="row">
								<div class="col-md-6">
									<div class="mb-3">
										<label class="form-label">Customer *</label> <select
											th:field="*{customerId}" class="form-select" required>
											<option value="">Select Customer</option>
											<option th:each="customer : ${customers}"
												th:value="${customer.id}"
												th:text="${customer.name + ' (' + customer.gstin + ')'}"></option>
										</select>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="card mb-4">
						<div
							class="card-header d-flex justify-content-between align-items-center">
							<h5 class="card-title mb-0">Invoice Items</h5>
							<button type="button" id="add-item"
								class="btn btn-success btn-sm">Add Item</button>
						</div>
						<div class="card-body">
							<div id="items-container">
								<div class="item-row row mb-3">
									<div class="col-md-4">
										<label class="form-label">Product *</label> <select
											class="form-select product-select" name="items[0].productId"
											required>
											<option value="">Select Product</option>
											<option th:each="product : ${products}"
												th:value="${product.id}"
												th:text="${product.name + ' - ₹' + product.price + ' (GST: ' + product.gstRate + '%)'}"></option>
										</select>
									</div>
									<div class="col-md-2">
										<label class="form-label">Quantity *</label> <input
											type="number" class="form-control quantity"
											name="items[0].quantity" min="1" value="1" required>
									</div>
									<div class="col-md-4">
										<label class="form-label">Item Total</label>
										<div class="form-control-plaintext">
											<span class="item-total fw-bold">₹0.00</span>
										</div>
									</div>
									<div class="col-md-2">
										<label class="form-label">&nbsp;</label>
										<button type="button"
											class="btn btn-danger btn-sm remove-item w-100">Remove</button>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="card mb-4">
						<div class="card-header">
							<h5 class="card-title mb-0">Invoice Summary</h5>
						</div>
						<div class="card-body">
							<div class="row">
								<div class="col-md-6 offset-md-6">
									<table class="table table-bordered">
										<tr>
											<th class="bg-light">Subtotal:</th>
											<td id="subtotal" class="text-end">₹0.00</td>
										</tr>
										<tr>
											<th class="bg-light">Total GST:</th>
											<td id="total-gst" class="text-end">₹0.00</td>
										</tr>
										<tr class="table-primary">
											<th class="bg-light">Total Amount:</th>
											<td id="total-amount" class="text-end fw-bold">₹0.00</td>
										</tr>
									</table>
								</div>
							</div>
						</div>
					</div>

					<div class="d-grid gap-2 d-md-flex justify-content-md-end">
						<a th:href="@{/dashboard}" class="btn btn-secondary me-md-2">Cancel</a>
						<button type="submit" class="btn btn-primary">Create
							Invoice</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	<div th:replace="fragments/footer :: footer"></div>
	<script>
	 document.addEventListener('DOMContentLoaded', function() {
	        const itemsContainer = document.getElementById('items-container');
	        const addItemBtn = document.getElementById('add-item');
	        const productData = {};
	        
	        // Initialize product data from options
	        document.querySelectorAll('.product-select option').forEach(option => {
	            if (option.value) {
	                const text = option.textContent;
	                const priceMatch = text.match(/₹(\d+\.?\d*)/);
	                const gstMatch = text.match(/GST: (\d+\.?\d*)%/);
	                
	                if (priceMatch && gstMatch) {
	                    productData[option.value] = {
	                        price: parseFloat(priceMatch[1]),
	                        gstRate: parseFloat(gstMatch[1])
	                    };
	                }
	            }
	        });
            
            addItemBtn.addEventListener('click', function() {
                const index = document.querySelectorAll('.item-row').length;
                const newRow = document.createElement('div');
                newRow.className = 'item-row row mb-3';
                newRow.innerHTML = `
                    <div class="col-md-4">
                        <label class="form-label">Product *</label>
                        <select class="form-select product-select" name="items[${index}].productId" required>
                            <option value="">Select Product</option>
                            ${document.querySelector('.product-select').innerHTML}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Quantity *</label>
                        <input type="number" class="form-control quantity" name="items[${index}].quantity" 
                               min="1" value="1" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Item Total</label>
                        <div class="form-control-plaintext">
                            <span class="item-total fw-bold">₹0.00</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-danger btn-sm remove-item w-100">Remove</button>
                    </div>
                `;
                itemsContainer.appendChild(newRow);
                attachEventListeners(newRow);
                calculateTotals();
            });
            
            function attachEventListeners(row) {
                const productSelect = row.querySelector('.product-select');
                const quantityInput = row.querySelector('.quantity');
                const removeBtn = row.querySelector('.remove-item');
                
                productSelect.addEventListener('change', calculateTotals);
                quantityInput.addEventListener('input', calculateTotals);
                removeBtn.addEventListener('click', function() {
                    row.remove();
                    calculateTotals();
                });
            }
            
            function calculateTotals() {
                let subtotal = 0;
                let totalGst = 0;
                
                document.querySelectorAll('.item-row').forEach(row => {
                    const productId = row.querySelector('.product-select').value;
                    const quantity = parseInt(row.querySelector('.quantity').value) || 0;
                    const itemTotal = row.querySelector('.item-total');
                    
                    if (productId && productData[productId]) {
                        const product = productData[productId];
                        const itemSubtotal = product.price * quantity;
                        const gstAmount = itemSubtotal * (product.gstRate / 100);
                        const itemTotalAmount = itemSubtotal + gstAmount;
                        
                        itemTotal.textContent = `₹${itemTotalAmount.toFixed(2)}`;
                        subtotal += itemSubtotal;
                        totalGst += gstAmount;
                    } else {
                        itemTotal.textContent = '₹0.00';
                    }
                });
                
                document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
                document.getElementById('total-gst').textContent = `₹${totalGst.toFixed(2)}`;
                document.getElementById('total-amount').textContent = `₹${(subtotal + totalGst).toFixed(2)}`;
            }
            
            // Attach listeners to initial row
            document.querySelectorAll('.item-row').forEach(attachEventListeners);
            calculateTotals();
        });
    </script>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>