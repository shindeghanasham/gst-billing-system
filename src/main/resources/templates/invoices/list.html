<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head('Manage Invoices')">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
	<div th:replace="fragments/navbar :: navbar"></div>

	<div class="container mt-4 mb-3">
		<div class="d-flex justify-content-between align-items-center mb-4">
			<h2>Manage Invoices</h2>
			<a th:href="@{/invoices/create}" class="btn btn-primary"> <i
				class="fas fa-plus"></i> Create New Invoice
			</a> <a class="btn btn-success" th:href="@{/invoices/download/excel}">
				<i class="fas fa-file-excel"></i> Download Excel
			</a>
		</div>

		<!-- Flash Messages -->
		<div th:if="${message}"
			class="alert alert-success alert-dismissible fade show" role="alert">
			<span th:text="${message}"></span>
			<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
		</div>
		<div th:if="${error}"
			class="alert alert-danger alert-dismissible fade show" role="alert">
			<span th:text="${error}"></span>
			<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
		</div>

		<!-- Statistics Cards -->
		<div class="row mb-4">
			<div class="col-md-3">
				<div class="card text-white bg-primary">
					<div class="card-body">
						<div class="d-flex justify-content-between">
							<div>
								<h6 class="card-title">Total Invoices</h6>
								<h3 th:text="${totalInvoices}" class="card-text">0</h3>
							</div>
							<div class="align-self-center">
								<i class="fas fa-file-invoice fa-2x"></i>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card text-white bg-success">
					<div class="card-body">
						<div class="d-flex justify-content-between">
							<div>
								<h6 class="card-title">Total Revenue</h6>
								<h3
									th:text="'₹' + ${#numbers.formatDecimal(totalRevenue, 1, 2)}"
									class="card-text">₹0.00</h3>
							</div>
							<div class="align-self-center">
								<i class="fas fa-money-bill-wave fa-2x"></i>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card text-white bg-warning">
					<div class="card-body">
						<div class="d-flex justify-content-between">
							<div>
								<h6 class="card-title">Total GST</h6>
								<h3 th:text="'₹' + ${#numbers.formatDecimal(totalGst, 1, 2)}"
									class="card-text">₹0.00</h3>
							</div>
							<div class="align-self-center">
								<i class="fas fa-percentage fa-2x"></i>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card text-white bg-info">
					<div class="card-body">
						<div class="d-flex justify-content-between">
							<div>
								<h6 class="card-title">This Month</h6>
								<h3 th:text="${monthlyInvoices}" class="card-text">0</h3>
							</div>
							<div class="align-self-center">
								<i class="fas fa-calendar-alt fa-2x"></i>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Search and Filter Section -->
		<div class="card mb-4">
			<div class="card-header">
				<h5 class="card-title mb-0">Search & Filter</h5>
			</div>
			<div class="card-body">
				<form th:action="@{/invoices/search}" method="get" class="row g-3">
					<div class="col-md-4">
						<label for="searchTerm" class="form-label">Search</label> <input
							type="text" class="form-control" id="searchTerm" name="query"
							placeholder="Search by invoice number, customer name..."
							th:value="${searchQuery}">
					</div>
					<div class="col-md-3">
						<label for="startDate" class="form-label">From Date</label> <input
							type="date" class="form-control" id="startDate" name="startDate"
							th:value="${startDate}">
					</div>
					<div class="col-md-3">
						<label for="endDate" class="form-label">To Date</label> <input
							type="date" class="form-control" id="endDate" name="endDate"
							th:value="${endDate}">
					</div>
					<div class="col-md-2">
						<label class="form-label">&nbsp;</label>
						<div class="d-grid gap-2">
							<button type="submit" class="btn btn-primary">Search</button>
						</div>
					</div>
				</form>
				<div class="mt-2">
					<a th:href="@{/invoices/list}"
						class="btn btn-outline-secondary btn-sm">Clear Filters</a>
				</div>
			</div>
		</div>

		<!-- Invoices Table -->
		<div class="card">
			<div class="card-body">
				<div th:if="${invoices.empty}" class="text-center py-4">
					<h5 class="text-muted">No invoices found</h5>
					<p class="text-muted">Get started by creating your first
						invoice.</p>
					<a th:href="@{/invoices/create}" class="btn btn-primary">Create
						Invoice</a>
				</div>

				<div th:unless="${invoices.empty}" class="table-responsive">
					<table class="table table-striped table-hover">
						<thead class="table-dark">
							<tr>
								<th>Invoice #</th>
								<th>Date</th>
								<th>Customer</th>
								<th>Items</th>
								<th class="text-end">Subtotal</th>
								<th class="text-end">GST</th>
								<th class="text-end">Total</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="invoice : ${invoices}">
								<td><strong th:text="${invoice.invoiceNumber}"></strong></td>
								<td
									th:text="${#temporals.format(invoice.invoiceDate, 'dd/MM/yyyy')}"></td>
								<td>
									<div th:text="${invoice.customer.name}"></div> <small
									class="text-muted" th:if="${invoice.customer.gstin}"
									th:text="${invoice.customer.gstin}"></small>
								</td>
								<td><span th:each="item, stat : ${invoice.items}"> <span
										th:text="${item.product.name} + ' (' + item.quantity + ')'"></span>
										<span th:if="${!stat.last}">, </span>
								</span></td>
								<td class="text-end"
									th:text="'₹' + ${#numbers.formatDecimal(invoice.subtotal, 1, 2)}"></td>
								<td class="text-end"
									th:text="'₹' + ${#numbers.formatDecimal(invoice.totalGst, 1, 2)}"></td>
								<td class="text-end"><strong
									th:text="'₹' + ${#numbers.formatDecimal(invoice.totalAmount, 1, 2)}"></strong>
								</td>
								<td>
									<div class="btn-group btn-group-sm">
										<a th:href="@{/invoices/view/{id}(id=${invoice.id})}"
											class="btn btn-outline-info" title="View Invoice"> <i
											class="fas fa-eye"></i>
										</a> <a th:href="@{/invoices/download/{id}(id=${invoice.id})}"
											class="btn btn-outline-success" title="Download PDF"> <i
											class="fas fa-download"></i>
										</a> <a th:href="@{/invoices/delete/{id}(id=${invoice.id})}"
											class="btn btn-outline-danger" title="Delete Invoice"
											onclick="return confirm('Are you sure you want to delete this invoice? This action cannot be undone.')">
											<i class="fas fa-trash"></i>
										</a>
									</div>
								</td>
							</tr>
						</tbody>
					</table>
				</div>

				<!-- Pagination (if implemented) -->
				<div th:if="${totalPages > 1}"
					class="d-flex justify-content-between align-items-center mt-4">
					<div class="text-muted">
						Showing <span th:text="${currentPage + 1}">1</span> of <span
							th:text="${totalPages}">1</span> pages
					</div>
					<nav>
						<ul class="pagination">
							<li class="page-item"
								th:classappend="${currentPage == 0} ? 'disabled' : ''"><a
								class="page-link" th:href="@{/invoices/list(page=0)}">First</a>
							</li>
							<li class="page-item"
								th:classappend="${currentPage == 0} ? 'disabled' : ''"><a
								class="page-link"
								th:href="@{/invoices/list(page=${currentPage - 1})}">Previous</a>
							</li>

							<li th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
								class="page-item"
								th:classappend="${i == currentPage} ? 'active' : ''"><a
								class="page-link" th:href="@{/invoices/list(page=${i})}"
								th:text="${i + 1}"></a></li>

							<li class="page-item"
								th:classappend="${currentPage == totalPages - 1} ? 'disabled' : ''">
								<a class="page-link"
								th:href="@{/invoices/list(page=${currentPage + 1})}">Next</a>
							</li>
							<li class="page-item"
								th:classappend="${currentPage == totalPages - 1} ? 'disabled' : ''">
								<a class="page-link"
								th:href="@{/invoices/list(page=${totalPages - 1})}">Last</a>
							</li>
						</ul>
					</nav>
				</div>
			</div>
		</div>

		<!-- Quick Actions -->
		<div class="card mt-4">
			<div class="card-header">
				<h5 class="card-title mb-0">Quick Actions</h5>
			</div>
			<div class="card-body">
				<div class="row">
					<div class="col-md-3">
						<a th:href="@{/invoices/create}"
							class="btn btn-primary w-100 mb-2"> <i
							class="fas fa-plus me-2"></i>Create Invoice
						</a>
					</div>
					<div class="col-md-3">
						<a th:href="@{/customers}" class="btn btn-success w-100 mb-2">
							<i class="fas fa-users me-2"></i>Manage Customers
						</a>
					</div>
					<div class="col-md-3">
						<a th:href="@{/products}" class="btn btn-warning w-100 mb-2">
							<i class="fas fa-boxes me-2"></i>Manage Products
						</a>
					</div>
					<div class="col-md-3">
						<button class="btn btn-info w-100 mb-2" onclick="window.print()">
							<i class="fas fa-print me-2"></i>Print List
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div th:replace="fragments/footer :: footer"></div>
	<!-- Font Awesome for Icons -->
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

	<style>
.table th {
	border-top: none;
	font-weight: 600;
}

.btn-group-sm>.btn {
	padding: 0.25rem 0.5rem;
}

@media print {
    body {
        background: white !important;
    }
    .navbar, .card-header, .btn, .pagination, .card-footer {
        display: none !important;
    }
    .card {
        border: none !important;
        box-shadow: none !important;
    }
}
</style>
</body>
</html>