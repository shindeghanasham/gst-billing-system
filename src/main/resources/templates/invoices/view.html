<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<div th:replace="fragments/header :: head('View Invoice')"></div>
<style>
.invoice-container {
	max-width: 900px;
	margin: 0 auto;
}

.invoice-header {
	border-bottom: 2px solid #dee2e6;
	padding-bottom: 20px;
	margin-bottom: 30px;
}

.company-info {
	background: #f8f9fa;
	padding: 20px;
	border-radius: 8px;
}

.invoice-table th {
	background-color: #f8f9fa;
	font-weight: 600;
}

.summary-card {
	background: #f8f9fa;
	border-left: 4px solid #007bff;
}

.print-only {
	display: none;
}

@media print {
	.no-print {
		display: none !important;
	}
	.print-only {
		display: block !important;
	}
	body {
		font-size: 12px;
	}
	.container {
		max-width: 100% !important;
		padding: 0 !important;
	}
	.card {
		border: none !important;
		box-shadow: none !important;
	}
}
</style>
</head>
<body>
	<div th:replace="fragments/navbar :: navbar" class="no-print"></div>

	<div class="container mt-4 mb-3">
		<div class="invoice-container">
			<!-- Flash Messages -->
			<div th:if="${param.message}"
				class="alert alert-success alert-dismissible fade show" role="alert">
				<span th:text="${param.message}"></span>
				<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
			</div>
			<div th:if="${param.error}"
				class="alert alert-danger alert-dismissible fade show" role="alert">
				<span th:text="${param.error}"></span>
				<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
			</div>

			<!-- Action Buttons -->
			<div
				class="d-flex justify-content-between align-items-center mb-4 no-print">
				<div>
					<a th:href="@{/invoices/list}" class="btn btn-outline-secondary">
						<i class="fas fa-arrow-left"></i> Back to Invoices
					</a>
				</div>
				<div class="btn-group">
					<a th:href="@{/invoices/download/{id}(id=${invoice.id})}"
						class="btn btn-success"> <i class="fas fa-download"></i>
						Download PDF
					</a>
					<button onclick="window.print()" class="btn btn-info">
						<i class="fas fa-print"></i> Print
					</button>
					<a th:href="@{/invoices/create}" class="btn btn-primary"> <i
						class="fas fa-plus"></i> New Invoice
					</a>
				</div>
			</div>

			<!-- Invoice Content -->
			<div class="card">
				<div class="card-body">
					<!-- Invoice Header -->
					<div class="invoice-header">
						<div class="row">
							<div class="col-md-6">
								<div class="company-info">
									<h3 class="text-primary mb-2">GST Billing System</h3>
									<p class="mb-1">
										<strong>Address:</strong> 123 Business Street, City, State -
										560001
									</p>
									<p class="mb-1">
										<strong>Phone:</strong> +91 9876543210
									</p>
									<p class="mb-1">
										<strong>Email:</strong> info@gstbilling.com
									</p>
									<p class="mb-0">
										<strong>GSTIN:</strong> 29AABCU9603R1ZX
									</p>
								</div>
							</div>
							<div class="col-md-6 text-end">
								<h1 class="text-primary">TAX INVOICE</h1>
								<div class="mt-3">
									<p class="mb-1">
										<strong>Invoice Number:</strong> <span
											th:text="${invoice.invoiceNumber}" class="text-dark"></span>
									</p>
									<p class="mb-1">
										<strong>Invoice Date:</strong> <span
											th:text="${#temporals.format(invoice.invoiceDate, 'dd/MM/yyyy')}"
											class="text-dark"></span>
									</p>
									<p class="mb-0">
										<strong>Created By:</strong> <span
											th:text="${invoice.user.username}" class="text-dark"></span>
									</p>
								</div>
							</div>
						</div>
					</div>

					<!-- Customer Information -->
					<div class="row mb-4">
						<div class="col-md-6">
							<h5 class="text-primary mb-3">Bill To:</h5>
							<div class="card">
								<div class="card-body">
									<h6 th:text="${invoice.customer.name}" class="card-title mb-2"></h6>
									<p class="card-text mb-1" th:if="${invoice.customer.gstin}">
										<strong>GSTIN:</strong> <span
											th:text="${invoice.customer.gstin}"></span>
									</p>
									<p class="card-text mb-1" th:if="${invoice.customer.phone}">
										<strong>Phone:</strong> <span
											th:text="${invoice.customer.phone}"></span>
									</p>
									<p class="card-text mb-1" th:if="${invoice.customer.email}">
										<strong>Email:</strong> <span
											th:text="${invoice.customer.email}"></span>
									</p>
									<p class="card-text mb-0" th:if="${invoice.customer.address}">
										<strong>Address:</strong> <span
											th:text="${invoice.customer.address}"></span>
									</p>
								</div>
							</div>
						</div>
						<div class="col-md-6">
							<h5 class="text-primary mb-3">Payment Details:</h5>
							<div class="card">
								<div class="card-body">
									<p class="card-text mb-1">
										<strong>Payment Method:</strong> Bank Transfer
									</p>
									<p class="card-text mb-1">
										<strong>Due Date:</strong> <span
											th:text="${#temporals.format(invoice.invoiceDate.plusDays(15), 'dd/MM/yyyy')}"></span>
									</p>
									<p class="card-text mb-0">
										<strong>Status:</strong> <span class="badge bg-success">Paid</span>
									</p>
								</div>
							</div>
						</div>
					</div>

					<!-- Invoice Items Table -->
					<div class="table-responsive mb-4">
						<table class="table table-bordered invoice-table">
							<thead class="table-primary">
								<tr>
									<th width="5%">#</th>
									<th width="40%">Product Description</th>
									<th width="10%">HSN Code</th>
									<th width="10%" class="text-center">Quantity</th>
									<th width="10%" class="text-end">Unit Price (₹)</th>
									<th width="10%" class="text-end">GST Rate (%)</th>
									<th width="15%" class="text-end">Amount (₹)</th>
								</tr>
							</thead>
							<tbody>
								<tr th:each="item, stat : ${invoice.items}">
									<td th:text="${stat.count}"></td>
									<td><strong th:text="${item.product.name}"></strong>
										<div th:if="${item.product.description}"
											class="text-muted small"
											th:text="${item.product.description}"></div></td>
									<td th:text="${item.product.hsnCode} ?: 'N/A'"></td>
									<td class="text-center" th:text="${item.quantity}"></td>
									<td class="text-end"
										th:text="${#numbers.formatDecimal(item.unitPrice, 1, 2)}"></td>
									<td class="text-end"
										th:text="${#numbers.formatDecimal(item.gstRate, 1, 2)}"></td>
									<td class="text-end"
										th:text="${#numbers.formatDecimal(item.totalAmount, 1, 2)}"></td>
								</tr>
								<!-- Empty row message -->
								<tr th:if="${invoice.items == null || invoice.items.empty}">
									<td colspan="7" class="text-center text-muted py-4">No
										items found in this invoice</td>
								</tr>
							</tbody>
						</table>
					</div>

					<!-- Invoice Summary -->
					<div class="row">
						<div class="col-md-6">
							<div class="card">
								<div class="card-header">
									<h6 class="card-title mb-0">Terms & Conditions</h6>
								</div>
								<div class="card-body">
									<ul class="list-unstyled small mb-0">
										<li>• Goods once sold will not be taken back</li>
										<li>• Payment should be made within 15 days</li>
										<li>• Interest @18% p.a. will be charged on overdue
											payments</li>
										<li>• Subject to [City] jurisdiction only</li>
									</ul>
								</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="card summary-card">
								<div class="card-body">
									<div class="row mb-2">
										<div class="col-6">
											<strong>Subtotal:</strong>
										</div>
										<div class="col-6 text-end">
											₹<span
												th:text="${#numbers.formatDecimal(invoice.subtotal, 1, 2)}"></span>
										</div>
									</div>
									<div class="row mb-2">
										<div class="col-6">
											<strong>Total GST:</strong>
										</div>
										<div class="col-6 text-end">
											₹<span
												th:text="${#numbers.formatDecimal(invoice.totalGst, 1, 2)}"></span>
										</div>
									</div>
									<hr>
									<div class="row mb-2">
										<div class="col-6">
											<strong>Grand Total:</strong>
										</div>
										<div class="col-6 text-end">
											<h5 class="text-primary">
												₹<span
													th:text="${#numbers.formatDecimal(invoice.totalAmount, 1, 2)}"></span>
											</h5>
										</div>
									</div>
									<div class="row">
										<div class="col-12">
											<small class="text-muted"> <strong>Amount in
													Words:</strong> <span
												th:text="${#numbers.formatDecimal(invoice.totalAmount, 1, 2) + ' Rupees Only'}"></span>
											</small>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- GST Breakdown - Simplified Version -->
					<!-- Advanced GST Breakdown -->
					<div class="card mt-4" th:if="${!gstBreakdown.isEmpty()}">
						<div class="card-header">
							<h6 class="card-title mb-0">GST Breakdown by Rate</h6>
						</div>
						<div class="card-body">
							<div class="table-responsive">
								<table class="table table-sm table-bordered">
									<thead>
										<tr>
											<th>GST Rate</th>
											<th class="text-end">Taxable Amount</th>
											<th class="text-end">CGST (50%)</th>
											<th class="text-end">SGST (50%)</th>
											<th class="text-end">Total GST</th>
										</tr>
									</thead>
									<tbody>
										<tr th:each="entry : ${gstBreakdown}">
											<td
												th:text="${#numbers.formatDecimal(entry.key, 1, 2) + '%'}"></td>
											<td class="text-end">₹<span
												th:text="${#numbers.formatDecimal(entry.value.taxableAmount, 1, 2)}"></span></td>
											<td class="text-end">₹<span
												th:text="${#numbers.formatDecimal(entry.value.cgst, 1, 2)}"></span></td>
											<td class="text-end">₹<span
												th:text="${#numbers.formatDecimal(entry.value.sgst, 1, 2)}"></span></td>
											<td class="text-end">₹<span
												th:text="${#numbers.formatDecimal(entry.value.gstAmount, 1, 2)}"></span></td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>

					<!-- Footer -->
					<div class="row mt-5">
						<div class="col-md-6 text-center">
							<p class="mb-1">_________________________</p>
							<p class="mb-0">
								<strong>Customer Signature</strong>
							</p>
						</div>
						<div class="col-md-6 text-center">
							<p class="mb-1">_________________________</p>
							<p class="mb-0">
								<strong>Authorized Signatory</strong>
							</p>
						</div>
					</div>

					<!-- Print Notice -->
					<div class="print-only mt-4">
						<p class="text-center text-muted small">This is a
							computer-generated invoice and does not require a physical
							signature.</p>
					</div>
				</div>
			</div>

			<!-- Bottom Action Buttons -->
			<div class="d-flex justify-content-center mt-4 no-print">
				<div class="btn-group">
					<a th:href="@{/invoices/download/{id}(id=${invoice.id})}"
						class="btn btn-success"> <i class="fas fa-download"></i>
						Download PDF
					</a>
					<button onclick="window.print()" class="btn btn-info">
						<i class="fas fa-print"></i> Print Invoice
					</button>
					<a th:href="@{/invoices/delete/{id}(id=${invoice.id})}"
						class="btn btn-danger"
						onclick="return confirm('Are you sure you want to delete this invoice? This action cannot be undone.')">
						<i class="fas fa-trash"></i> Delete Invoice
					</a>
				</div>
			</div>
		</div>
	</div>
	<!-- Font Awesome for Icons -->
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

	<script>
        // Enhance print functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Add print styles
            const style = document.createElement('style');
            style.textContent = `
                @media print {
                    .no-print { display: none !important; }
                    .print-only { display: block !important; }
                    body { font-size: 12px; -webkit-print-color-adjust: exact; }
                    .container { max-width: 100% !important; padding: 0 !important; }
                    .card { border: none !important; box-shadow: none !important; }
                    .table { border: 1px solid #dee2e6 !important; }
                    .table th { background-color: #f8f9fa !important; }
                    .text-primary { color: #000 !important; }
                }
            `;
            document.head.appendChild(style);
        });

        // Auto-print if requested
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('print') === 'true') {
            window.print();
        }
    </script>
</body>
</html>